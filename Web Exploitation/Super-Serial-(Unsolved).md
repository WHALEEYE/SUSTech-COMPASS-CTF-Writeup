# Super Serial (Unsolved)

Try to recover the flag stored on this website http://mercury.picoctf.net:42449/。

## WP

进入网页后，看到一个登录界面，使用一些常见的payload进行SQL注入，失败。

![image-20210709214453144](Super-Serial.assets/image-20210709214453144.png)

在网页源码中也没有看到关键的信息，于是想去看看网站有没有`robots.txt`碰碰运气，没想到真的有，且屏蔽了`/admin.phps`页面。

![image-20210709214641953](Super-Serial.assets/image-20210709214641953.png)

然而，当我尝试访问`/admin.phps`时，却发现没有这个页面。不仅如此，`admin.php`也显示为Not Found。

思路似乎断了，但是`.phps`后缀名给了我一点启发：会不会在这个网站的目录下存在着很多以`.phps`为后缀的文件呢？

尝试访问`index.phps`，居然成功了，而且还回显了`index.php`的源码。

![image-20210709215007165](Super-Serial.assets/image-20210709215007165.png)

顺藤摸瓜，发现了`cookie.phps`和`authentication.phps`，这两个页面也分别包含了`cookie.php`和`authentication.php`的源码。

整理出该网站登录并检测用户身份的过程：

1. 将用户输入的账号和密码放入数据库查询，若查询到用户，生成一个permission对象并序列化后将Cookie中的login值设置为使用BASE64编码的序列化后的字符串。（`index.php`）

   ```php
   if(isset($_POST["user"]) && isset($_POST["pass"])){
   	$con = new SQLite3("../users.db");
   	$username = $_POST["user"];
   	$password = $_POST["pass"];
   	$perm_res = new permissions($username, $password);
   	if ($perm_res->is_guest() || $perm_res->is_admin()) {
   		setcookie("login", urlencode(base64_encode(serialize($perm_res))), time() + (86400 * 30), "/");
   		header("Location: authentication.php");
   		die();
   	} else {
   		$msg = '<h6 class="text-center" style="color:red">Invalid Login.</h6>';
   	}
   }
   ```

2. 当用户访问时，若Cookie信息中包含login，则将该对象反序列化后解析，并分析出该用户的身份为admin还是guest。（`cookie.php`）

   ```php
   if(isset($_COOKIE["login"])){
   	try{
   		$perm = unserialize(base64_decode(urldecode($_COOKIE["login"])));
   		$g = $perm->is_guest();
   		$a = $perm->is_admin();
   	}
   	catch(Error $e){
   		die("Deserialization error. ".$perm);
   	}
   }
   ```

3. 根据用户的身份显示不同的信息。（`authentication.php`）

   ```php
   if(isset($perm) && $perm->is_admin()){
   	$msg = "Welcome admin";
   	$log = new access_log("access.log");
   	$log->append_to_log("Logged in at ".date("Y-m-d")."\n");
   } else {
   	$msg = "Welcome guest";
   }
   ?>
   ```

目前推测`access.log`中有重要信息，但是还没有找到进一步深入的方法，推测为反序列化漏洞。